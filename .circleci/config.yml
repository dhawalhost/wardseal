# CircleCI Configuration for Identity Platform
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Orbs for reusable configuration
orbs:
  go: circleci/go@1.11
  node: circleci/node@5.2
  docker: circleci/docker@2.6

# Executors
executors:
  go-executor:
    docker:
      - image: cimg/go:1.22
    working_directory: ~/project
    environment:
      GO111MODULE: "on"
      CGO_ENABLED: "0"

  go-with-postgres:
    docker:
      - image: cimg/go:1.22
      - image: cimg/postgres:15.0
        environment:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: identity_platform_test
    working_directory: ~/project
    environment:
      GO111MODULE: "on"
      TEST_DB_HOST: localhost
      TEST_DB_USER: user
      TEST_DB_PASSWORD: password
      TEST_DB_NAME: identity_platform_test

  node-executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project/web/admin

# Commands for reusable steps
commands:
  install-golangci-lint:
    steps:
      - run:
          name: Install golangci-lint
          command: |
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.7.2

  wait-for-postgres:
    steps:
      - run:
          name: Wait for PostgreSQL
          command: |
            for i in $(seq 1 30); do
              if pg_isready -h localhost -U user; then
                echo "PostgreSQL is ready"
                exit 0
              fi
              echo "Waiting for PostgreSQL..."
              sleep 2
            done
            echo "PostgreSQL did not become ready in time"
            exit 1

  restore-go-cache:
    steps:
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}
            - go-mod-v1-

  save-go-cache:
    steps:
      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod

# Jobs
jobs:
  # Lint Go code
  lint:
    executor: go-executor
    steps:
      - checkout
      - restore-go-cache
      - install-golangci-lint
      - run:
          name: Download dependencies
          command: go mod download
      - save-go-cache
      - run:
          name: Run golangci-lint
          command: golangci-lint run --timeout=5m ./...

  # Run unit tests
  test:
    executor: go-executor
    steps:
      - checkout
      - restore-go-cache
      - run:
          name: Download dependencies
          command: go mod download
      - save-go-cache
      - run:
          name: Run unit tests
          command: |
            mkdir -p /tmp/test-results
            go test -v -race -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee /tmp/test-results/go-test.out
            go tool cover -html=coverage.out -o /tmp/test-results/coverage.html
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results
          destination: test-results

  # Run integration tests with PostgreSQL
  integration-test:
    executor: go-with-postgres
    steps:
      - checkout
      - restore-go-cache
      - run:
          name: Install PostgreSQL client
          command: sudo apt-get update && sudo apt-get install -y postgresql-client
      - wait-for-postgres
      - run:
          name: Download dependencies
          command: go mod download
      - save-go-cache
      - run:
          name: Run database migrations
          command: |
            # Install migrate tool
            curl -L https://github.com/golang-migrate/migrate/releases/download/v4.15.2/migrate.linux-amd64.tar.gz | tar xvz
            ./migrate -path migrations -database "postgres://user:password@localhost:5432/identity_platform_test?sslmode=disable" up
      - run:
          name: Run integration tests
          command: |
            mkdir -p /tmp/test-results
            go test -v -tags=integration ./tests/integration/... 2>&1 | tee /tmp/test-results/integration-test.out
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results
          destination: integration-results

  # Build all Go service binaries
  build-backend:
    executor: go-executor
    steps:
      - checkout
      - restore-go-cache
      - run:
          name: Download dependencies
          command: go mod download
      - save-go-cache
      - run:
          name: Build all services
          command: |
            mkdir -p bin
            for svc in authsvc dirsvc govsvc policysvc provsvc; do
              echo "Building $svc..."
              go build -o bin/$svc ./cmd/$svc
            done
      - persist_to_workspace:
          root: .
          paths:
            - bin

  # Build frontend
  build-frontend:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: ~/project/web/admin
      - run:
          name: Build frontend
          command: npm run build
          working_directory: ~/project/web/admin
      - persist_to_workspace:
          root: ~/project
          paths:
            - web/admin/dist

  # Build Docker images
  build-images:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker images
          command: |
            # Build service images
            for svc in authsvc dirsvc govsvc policysvc provsvc; do
              if [ -f cmd/$svc/Dockerfile ]; then
                echo "Building $svc image..."
                docker build -t ${DOCKER_REGISTRY:-wardseal}/$svc:${CIRCLE_SHA1} -f cmd/$svc/Dockerfile .
                docker tag ${DOCKER_REGISTRY:-wardseal}/$svc:${CIRCLE_SHA1} ${DOCKER_REGISTRY:-wardseal}/$svc:latest
              fi
            done
            
            # Build admin UI image
            if [ -f web/admin/Dockerfile ]; then
              echo "Building admin-ui image..."
              docker build -t ${DOCKER_REGISTRY:-wardseal}/admin-ui:${CIRCLE_SHA1} -f web/admin/Dockerfile web/admin
              docker tag ${DOCKER_REGISTRY:-wardseal}/admin-ui:${CIRCLE_SHA1} ${DOCKER_REGISTRY:-wardseal}/admin-ui:latest
            fi

  # Push Docker images to registry
  push-images:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Login to GitHub Container Registry
          command: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
      - run:
          name: Build and push Docker images
          command: |
            for svc in authsvc dirsvc govsvc policysvc provsvc; do
              if [ -f cmd/$svc/Dockerfile ]; then
                echo "Building and pushing $svc..."
                docker build -t ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-$svc:${CIRCLE_SHA1} -f cmd/$svc/Dockerfile .
                docker tag ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-$svc:${CIRCLE_SHA1} ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-$svc:latest
                docker push ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-$svc:${CIRCLE_SHA1}
                docker push ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-$svc:latest
              fi
            done
            
            if [ -f web/admin/Dockerfile ]; then
              echo "Building and pushing admin-ui..."
              docker build -t ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-admin-ui:${CIRCLE_SHA1} -f web/admin/Dockerfile web/admin
              docker tag ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-admin-ui:${CIRCLE_SHA1} ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-admin-ui:latest
              docker push ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-admin-ui:${CIRCLE_SHA1}
              docker push ghcr.io/${GHCR_OWNER:-dhawalhost}/wardseal-admin-ui:latest
            fi

  # Update image tags in Helm values and commit (triggers ArgoCD sync)
  deploy-staging:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "${DEPLOY_KEY_FINGERPRINT}"  # Add your SSH key fingerprint
      - run:
          name: Configure Git
          command: |
            git config user.email "ci@wardseal.io"
            git config user.name "CircleCI"
      - run:
          name: Update image tags in staging values
          command: |
            # Update image tags in values-staging.yaml
            sed -i "s/tag: \".*\"/tag: \"${CIRCLE_SHA1}\"/" deploy/charts/wardseal/values-staging.yaml
      - run:
          name: Commit and push changes
          command: |
            git add deploy/charts/wardseal/values-staging.yaml
            git commit -m "ci: update staging image tags to ${CIRCLE_SHA1}" || echo "No changes to commit"
            git push origin main

# Workflows
workflows:
  # CI workflow - runs on all branches
  ci:
    jobs:
      - lint
      - test:
          requires:
            - lint
      - build-backend:
          requires:
            - test
      - build-frontend:
          requires:
            - lint
      - build-images:
          requires:
            - build-backend
            - build-frontend

  # CD workflow - runs on main branch only
  cd:
    jobs:
      - lint:
          filters:
            branches:
              only: main
      - test:
          requires:
            - lint
          filters:
            branches:
              only: main
      - integration-test:
          requires:
            - test
          filters:
            branches:
              only: main
      - build-backend:
          requires:
            - integration-test
          filters:
            branches:
              only: main
      - build-frontend:
          requires:
            - lint
          filters:
            branches:
              only: main
      - push-images:
          requires:
            - build-backend
            - build-frontend
          filters:
            branches:
              only: main
          context:
            - ghcr  # CircleCI context with GHCR_USERNAME, GHCR_TOKEN, GHCR_OWNER
            - staging-secrets  # CircleCI context with JWT_SIGNING_KEY, SERVICE_AUTH_TOKEN, etc.
      - deploy-staging:
          requires:
            - push-images
          filters:
            branches:
              only: main
          context:
            - ghcr